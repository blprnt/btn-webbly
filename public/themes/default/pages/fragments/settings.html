<link rel="stylesheet" href="/themes/default/css/fragments/edit.css" />

<template id="project-edit-template">
  <dialog>
    <h1>Project settings for "<span class="projectname"></span>"</h1>
    <form
      class="project-edit-form"
      action="/v1/projects/settings/"
      method="POST"
    >
      <fieldset class="project">
        <div>
          <label>Project name:</label>
          <input type="text" value="" name="name" />
          <span>{{ project.slug }}</span>
        </div>
        <div>
          <label>Project description:</label>
          <textarea rows="4" name="description"></textarea>
        </div>
        <div>
          {% set type = project.app_type %}
          <label>Project type {{ type }}:</label>
          <input type="radio" name="app_type" value="static" id="static" />
          <label for="static">static content</label>
          <input type="radio" name="app_type" value="docker" id="docker" />
          <label for="docker">persistent process</label>
        </div>
        <div>
          <label>Static content root dir:</label>
          <input
            type="text"
            value=""
            name="root_dir"
            placeholder="leave blank for project root dir"
          />
        </div>
      </fieldset>

      <fieldset class="container">
        <div>
          <label>Default selected file:</label>
          <input
            type="text"
            value=""
            name="default_file"
            placeholder="i.e. the file that gets opened when you load the editor"
          />
        </div>

        <div>
          <label>Default folders to show collapsed:</label>
          <textarea
            rows="4"
            name="default_collapse"
            placeholder="Each folder name should be on its own line, and if it's a nested folder: remember to specify the full path."
          ></textarea>
        </div>

        <div class="docker-only">
          <label>Run script:</label>
          <textarea rows="4" name="run_script"></textarea>
        </div>

        <div class="docker-only">
          <label>Environment variables:</label>
          <textarea
            rows="4"
            name="env_vars"
            placeholder="One per line, as varname=value"
          ></textarea>
        </div>
      </fieldset>

      <input type="reset" value="cancel" />
      <input type="submit" value="save" />
    </form>
  </dialog>
</template>

<script>
  async function showEditDialog(projectId) {
    const t = document.getElementById(`project-edit-template`);
    const d = t.content.cloneNode(true).querySelector(`dialog`);
    const url = `/v1/projects/settings/${projectId}`;
    const settings = await fetch(url, { method: `GET` }).then((r) => r.json());
    const template = (name) => {
      const e = d.querySelectorAll(`[name="${name}"]`);
      if (e.length) {
        if (e.length === 1) {
          e[0].value = settings[name];
        } else {
          e.forEach((e) => {
            if (e.value === settings[name]) {
              e.checked = true;
            }
          });
        }
      }
    };

    d.querySelector(`.projectname`).textContent = settings.name;
    Object.keys(settings).forEach(template);

    d.querySelector(`[type="reset"]`).addEventListener(`click`, () => {
      d.close();
      d.parentNode.removeChild(d);
    });

    const form = d.querySelector(`form`);
    form.addEventListener(`submit`, async (evt) => {
      evt.preventDefault();
      d.querySelector(`h1`).outerHTML = `<p>Saving...</p>`;
      form.style.display = `none`;

      const result = await fetch(url, {
        method: `POST`,
        body: new FormData(form),
      }).then((r) => r.text());

      if (result.startsWith(`/v1/projects/edit/`)) {
        location = result;
      } else {
        const ErrorNotice = window.__notices?.ErrorNotice ?? false;
        if (ErrorNotice) {
          // TODO: improve the error so folks know why.
          new ErrorNotice(`Could not save updated project settings`, 3000);
        }
        d.remove();
      }
    });

    document.body.appendChild(d);
    d.showModal();
    d.querySelector(`[name="description"]`).focus();
  }
</script>
