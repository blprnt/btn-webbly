var c=n=>document.createElement(n);var f=window.customElements;function y(n){return new Promise((t,e)=>{let r=new FileReader;r.onloadend=({target:i})=>t(i.result),r.onerror=e,r.readAsArrayBuffer(n)})}var v=globalThis.HTMLElement??class{},p=class extends v{state={};eventControllers=[];constructor(){if(super(),this.icon=this.find("& > .icon"),!this.icon){let t=this.icon=c("span");t.classList.add("icon"),this.appendChild(t)}if(this.heading=this.find("& > entry-heading"),!this.heading){let t=this.heading=c("entry-heading");this.appendChild(t)}if(this.buttons=this.find("& > span.buttons"),!this.buttons){let t=this.buttons=c("span");t.classList.add("buttons"),this.appendChild(t)}}addExternalListener(t,e,r,i={}){let s=new AbortController;i.signal=s.signal,t.addEventListener(e,r,i),this.addAbortController(s)}addListener(t,e,r={}){this.addExternalListener(this,t,e,r)}addAbortController(t){this.eventControllers.push(t)}disconnectedCallback(){let{eventControllers:t}=this;for(;t.length;)t.shift().abort()}get removeEmptyDir(){return this.root.removeEmptyDir}get name(){return this.getAttribute("name")}set name(t){this.setAttribute("name",t)}get path(){return this.getAttribute("path")}set path(t){if(!t)return;let e=t.endsWith("/")?-2:-1;if(this.name=t.split("/").at(e).replace(/#.*/,""),!this.name&&t)throw Error(`why? path is ${t}`);let r=this.find("& > entry-heading");r.textContent=this.name,this.setAttribute("path",t)}updatePath(t,e,r){if(this.path===e)return this.path=r,!0;if(t)return!1;let i=new RegExp(`^${e}`);return this.path=this.path.replace(i,r),!0}get dirPath(){let{path:t,name:e}=this;if(this.isFile)return t.replace(e,"");if(this.isDir)return t.substring(0,t.lastIndexOf(e));throw Error("entry is file nor dir.")}get root(){return this.closest("file-tree")}get parentDir(){let t=this;return t.tagName==="DIR-ENTRY"&&(t=t.parentNode),t.closest("dir-entry")}emit(t,e={},r=()=>{}){e.grant=r,this.root.dispatchEvent(new CustomEvent(t,{detail:e}))}find(t){return this.querySelector(t)}findInTree(t){return this.root.querySelector(t)}findAll(t){return Array.from(this.querySelectorAll(t))}findAllInTree(t){return Array.from(this.root.querySelectorAll(t))}hasButton(t){return this.find(`& > .buttons .${t}`)}select(){this.root.unselect(),this.classList.add("selected")}setState(t){Object.assign(this.state,t)}},T=class extends v{};f.define("entry-heading",T);var g=class{waitList={};pending=[];constructor(t,e,r=".",i=6e4){Object.assign(this,{fileTree:t,url:e,basePath:r,keepAliveInterval:i}),this.connect()}async connect(t=this.url,e=this.basePath){if(t=t.replace("https://","wss://"),!t.startsWith("wss://"))throw new Error("Only secure URLs are supported.");let r=this.socket=new WebSocket(t);r.addEventListener("message",({data:o})=>{o=JSON.parse(o);let{type:a,detail:h}=o;if(!a.startsWith("file-tree:"))return;a=a.replace("file-tree:","");let d=`on${a}`,u=this[d].bind(this);if(!u)throw new Error(`Missing implementation for ${d}.`);this.checkSync(a,h.seqnum)&&u(h)});let i,s=()=>{this.send("file-tree:keepalive",{basePath:e}),i=setTimeout(s,this.keepAliveInterval)};r.addEventListener("close",()=>{clearTimeout(i)}),r.addEventListener("open",()=>{this.send("file-tree:load",{basePath:e}),s()})}async markWaiting(t,e){this.waitList[t]=e}async send(t,e={}){let r={type:t,detail:e};this.pending.push(r),this.socket.send(JSON.stringify(r))}checkSync(t,e){if(t==="load"||t==="read")return!0;if(e===this.seqnum+1){let{pending:r}=this;return r.length&&(r[0].type===t?r.shift():this.rollback(r.reverse())),this.seqnum=e}this.send("file-tree:sync",{seqnum:this.seqnum})}rollback(t){this.pending=[];for(let{type:e,detail:r}of t)e==="create"&&this.fileTree.__delete(r.path),e==="delete"&&(this.fileTree.__create(r.path,r.isFile),this.read(path)),e==="move"&&this.fileTree.__move(r.isFile,r.newPath,r.oldPath),e==="update"&&this.read(path)}async create(t,e,r){this.send("file-tree:create",{path:t,isFile:e,content:r})}async delete(t){this.send("file-tree:delete",{path:t})}async move(t,e,r){this.send("file-tree:move",{isFile:t,oldPath:e,newPath:r})}async read(t){return new Promise(e=>{this.markWaiting(t,e),this.send("file-tree:read",{path:t})})}async update(t,e,r){this.send("file-tree:update",{path:t,type:e,update:r})}async onload({id:t,dirs:e,files:r,seqnum:i}){this.id=t,this.seqnum=i,this.fileTree.setContent({dirs:e,files:r},!0)}async onterminate({id:t,reconnect:e}){this.id===t&&(this.socket.close(),e&&this.connect())}async oncreate({path:t,isFile:e,from:r}){let{id:i,fileTree:s}=this;if(r===i)return;let o=s.__create(t,e);s.dispatchEvent(new CustomEvent("ot:created",{detail:{entry:o,path:t,isFile:e}}))}async ondelete({path:t,from:e}){let{id:r,fileTree:i}=this;if(e===r)return;let s=i.__delete(t);i.dispatchEvent(new CustomEvent("ot:deleted",{detail:{entries:s,path:t}}))}async onmove({isFile:t,oldPath:e,newPath:r,from:i}){let{id:s,fileTree:o}=this;if(i===s)return;let a=o.__move(t,e,r);o.dispatchEvent(new CustomEvent("ot:moved",{detail:{entry:a,isFile:t,oldPath:e,newPath:r}}))}async onread({path:t,data:e}){let{waitList:r}=this;r[t]?.({data:e}),delete r[t]}async onupdate({path:t,type:e,update:r,from:i}){let{id:s,fileTree:o}=this;o.__update(t,e,r,i===s)}};var A={"en-GB":{CREATE_FILE:"Create new file",CREATE_FILE_PROMPT:"Please specify a filename.",CREATE_FILE_NO_DIRS:"Just add new files directly to the directory where they should live.",RENAME_FILE:"Rename file",RENAME_FILE_PROMPT:"New file name?",RENAME_FILE_MOVE_INSTEAD:"If you want to relocate a file, just move it.",DELETE_FILE:"Delete file",DELETE_FILE_PROMPT:n=>`Are you sure you want to delete ${n}?`,CREATE_DIRECTORY:"Add new directory",CREATE_DIRECTORY_PROMPT:"Please specify a directory name.",CREATE_DIRECTORY_NO_NESTING:"You'll have to create nested directories one at a time.",RENAME_DIRECTORY:"Rename directory",RENAME_DIRECTORY_PROMPT:"Choose a new directory name",RENAME_DIRECTORY_MOVE_INSTEAD:"If you want to relocate a directory, just move it.",DELETE_DIRECTORY:"Delete directory",DELETE_DIRECTORY_PROMPT:n=>`Are you *sure* you want to delete ${n} and everything in it?`,UPLOAD_FILES:"Upload files from your device",PATH_EXISTS:n=>`${n} already exists.`,PATH_DOES_NOT_EXIST:n=>`${n} does not exist.`,PATH_INSIDE_ITSELF:n=>`Cannot nest ${n} inside its own subdirectory.`,INVALID_UPLOAD_TYPE:n=>`Unfortunately, a ${n} is not a file or folder.`}},I="en-GB",O=globalThis.navigator?.language,l=A[O]||A[I];function C({root:n,path:t}){let e=c("input");e.type="file",e.multiple=!0,confirm('To upload one or more files, press "OK". To upload an entire folder, press "Cancel".')||(e.webkitdirectory=!0),e.addEventListener("change",()=>{let{files:i}=e;i&&_(n,i,t)}),e.click()}async function _(n,t,e=""){let r=t.length>1;async function i(s,o=""){if(s instanceof File&&!s.isDirectory){let a=await y(s),h=o+(s.webkitRelativePath||s.name),d=(e==="."?"":e)+h;n.createEntry(d,!0,a,r)}else if(s.isFile)s.file(async a=>{let h=await y(a),d=o+a.name,u=(e==="."?"":e)+d;n.createEntry(u,!0,h,r)});else if(s.isDirectory){r=!0;let a=o+s.name+"/";n.createEntry(a,!1,!1,r),s.createReader().readEntries(async h=>{for(let d of h)await i(d,a)})}}for(let s of t)try{let o;!o&&s instanceof File&&(o=s),!o&&s.webkitGetAsEntry&&(o=s.webkitGetAsEntry()??o),!o&&s.getAsFile&&(o=s.getAsFile()),await i(o)}catch{return alert(l.INVALID_UPLOAD_TYPE(s.kind))}}function N(n){let t=new AbortController;n.draggable=!0;let e=()=>{n.findAllInTree(".drop-target").forEach(r=>r.classList.remove("drop-target"))};return n.addEventListener("dragstart",r=>{r.stopPropagation(),n.classList.add("dragging"),n.dataset.id=`${Date.now()}-${Math.random()}`,r.dataTransfer.setData("id",n.dataset.id)},{signal:t.signal}),n.addEventListener("dragenter",r=>{r.preventDefault(),e(),n.classList.add("drop-target")},{signal:t.signal}),n.addEventListener("dragover",r=>{let i=r.target;S(n,i)&&(r.preventDefault(),e(),n.classList.add("drop-target"))},{signal:t.signal}),n.addEventListener("dragleave",r=>{r.preventDefault(),e()},{signal:t.signal}),n.addEventListener("drop",async r=>{r.preventDefault(),r.stopPropagation(),e();let i=r.dataTransfer.getData("id");if(i)return b(n,i);await _(n.root,r.dataTransfer.items,n.path)},{signal:t.signal}),n.path==="."?n.draggable=!1:t}function S(n,t){return t===n?!0:t.closest("dir-entry")===n}function b(n,t){let e=n.findInTree(`[data-id="${t}"]`);if(delete e.dataset.id,e.classList.remove("dragging"),e===n)return;let r=e.path,i=n.path,s=(i!=="."?i:"")+e.name;e.isDir&&(s+="/"),n.root.moveEntry(e,r,s)}var E=class extends p{isDir=!0;constructor(t=!1){super(),this.addButtons(t)}get path(){return super.path}set path(t){super.path=t,t==="."&&(this.find("& > .rename-dir")?.remove(),this.find("& > .delete-dir")?.remove())}connectedCallback(){this.addListener("click",e=>this.selectListener(e)),this.addExternalListener(this.icon,"click",e=>this.foldListener(e));let t=N(this);t&&this.addAbortController(t)}selectListener(t){if(t.stopPropagation(),t.preventDefault(),this.path===".")return;let e=t.target.tagName;e!=="DIR-ENTRY"&&e!=="ENTRY-HEADING"||(this.root.selectEntry(this),this.classList.contains("closed")&&this.foldListener(t))}foldListener(t){if(t.stopPropagation(),t.preventDefault(),this.path===".")return;let e=this.classList.contains("closed");this.root.toggleDirectory(this,{currentState:e?"closed":"open"})}addButtons(t){this.createFileButton(),this.createDirButton(),this.addUploadButton(),t||(this.addRenameButton(),this.addDeleteButton())}createFileButton(){if(this.hasButton("create-file"))return;let t=c("button");t.classList.add("create-file"),t.title=l.CREATE_FILE,t.textContent="\u{1F4C4}",t.addEventListener("click",()=>this.#r()),this.buttons.appendChild(t)}#r(){let t=prompt(l.CREATE_FILE_PROMPT)?.trim();if(t){if(t.includes("/"))return alert(l.CREATE_FILE_NO_DIRS);this.path!=="."&&(t=this.path+t),this.root.createEntry(t,!0)}}createDirButton(){if(this.hasButton("create-dir"))return;let t=c("button");t.classList.add("create-dir"),t.title=l.CREATE_DIRECTORY,t.textContent="\u{1F4C1}",t.addEventListener("click",()=>this.#t()),this.buttons.appendChild(t)}#t(){let t=prompt(String.CREATE_DIRECTORY_PROMPT)?.trim();if(t){if(t.includes("/"))return alert(l.CREATE_DIRECTORY_NO_NESTING);let e=(this.path!=="."?this.path:"")+t+"/";this.root.createEntry(e,!1)}}addUploadButton(){if(this.hasButton("upload"))return;let t=c("button");t.classList.add("upload"),t.title=l.UPLOAD_FILES,t.textContent="\u{1F4BB}",t.addEventListener("click",()=>C(this)),this.buttons.appendChild(t)}addRenameButton(){if(this.path==="."||this.hasButton("rename-dir"))return;let t=c("button");t.classList.add("rename-dir"),t.title=l.RENAME_DIRECTORY,t.textContent="\u270F\uFE0F",this.buttons.appendChild(t),t.addEventListener("click",()=>this.#i())}#i(){let t=prompt(l.RENAME_DIRECTORY_PROMPT,this.name)?.trim();if(t){if(t.includes("/"))return alert(l.RENAME_DIRECTORY_MOVE_INSTEAD);this.root.renameEntry(this,t)}}addDeleteButton(){if(this.path==="."||this.hasButton("delete-dir"))return;let t=c("button");t.classList.add("delete-dir"),t.title=l.DELETE_DIRECTORY,t.textContent="\u{1F5D1}\uFE0F",this.buttons.appendChild(t),t.addEventListener("click",()=>this.#e())}#e(){let t=l.DELETE_DIRECTORY_PROMPT(this.path);confirm(t)&&this.root.removeEntry(this)}addEntry(t){this.appendChild(t),this.sort()}checkEmpty(){this.removeEmptyDir&&(this.find("dir-entry, file-entry")||this.root.removeEntry(this))}sort(t=!0,e=!0){let r=[...this.children];r.sort((i,s)=>{if(i.tagName==="SPAN"&&i.classList.contains("icon"))return-1;if(s.tagName==="SPAN"&&s.classList.contains("icon"))return 1;if(i.tagName==="ENTRY-HEADING")return-1;if(s.tagName==="ENTRY-HEADING")return 1;if(i.tagName==="SPAN"&&s.tagName==="SPAN")return 0;if(i.tagName==="SPAN")return-1;if(s.tagName==="SPAN")return 1;if(e){if(i.tagName==="DIR-ENTRY"&&s.tagName==="DIR-ENTRY")return i=i.path,s=s.path,i<s?-1:1;if(i.tagName==="DIR-ENTRY")return-1;if(s.tagName==="DIR-ENTRY")return 1}return i=i.path,s=s.path,i<s?-1:1}),r.forEach(i=>this.appendChild(i)),t&&this.findAll("& > dir-entry").forEach(i=>i.sort(t))}toggle(t){this.classList.toggle("closed",t)}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.toJSON()}toValue(){return this.root.toValue().filter(t=>t.startsWith(this.path))}};f.define("dir-entry",E);var m=class extends p{isFile=!0;constructor(t,e){super(t,e),this.addRenameButton(),this.addDeleteButton(),this.addEventHandling()}addRenameButton(){if(this.hasButton("rename-file"))return;let t=c("button");t.classList.add("rename-file"),t.title=l.RENAME_FILE,t.textContent="\u270F\uFE0F",this.buttons.appendChild(t),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let r=prompt(l.RENAME_FILE_PROMPT,this.heading.textContent)?.trim();if(r){if(r.includes("/"))return alert(l.RENAME_FILE_MOVE_INSTEAD);this.root.renameEntry(this,r)}})}addDeleteButton(){if(this.hasButton("delete-file"))return;let t=c("button");t.classList.add("delete-file"),t.title=l.DELETE_FILE,t.textContent="\u{1F5D1}\uFE0F",this.buttons.appendChild(t),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),confirm(l.DELETE_FILE_PROMPT(this.path))&&this.root.removeEntry(this)})}addEventHandling(){this.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.root.selectEntry(this)}),this.draggable=!0,this.addEventListener("dragstart",t=>{t.stopPropagation(),this.classList.add("dragging"),this.dataset.id=`${Date.now()}-${Math.random()}`,t.dataTransfer.setData("id",this.dataset.id)})}async load(){return this.root.loadEntry(this.path)}async updateContent(t,e){this.root.updateEntry(this.path,t,e)}toJSON(){return JSON.stringify(this.toValue())}toString(){return this.path}toValue(){return[this.toString()]}};f.define("file-entry",m);var D=class extends p{static observedAttributes=["src"];ready=!1;isTree=!0;entries={};constructor(){super(),this.heading.textContent="File tree"}get root(){return this}get parentDir(){return this.rootDir}get removeEmptyDir(){return!!this.getAttribute("remove-empty-dir")}clear(){this.ready=!1,this.emit("tree:clear"),Object.keys(this.entries).forEach(e=>delete this.entries[e]),this.rootDir&&this.removeChild(this.rootDir);let t=this.rootDir=new E(!0);t.path=".",this.appendChild(t)}connectedCallback(){this.addExternalListener(document,"dragend",()=>this.findAll(".dragging").forEach(t=>t.classList.remove("dragging")))}attributeChangedCallback(t,e,r){t==="src"&&r&&this.#r(r)}async connectViaWebSocket(t,e=".",r=6e4,i=g){return this.OT=new i(this,t,e,r),this.OT.socket}setContent({dirs:t,files:e},r=!1){return this.clear(),t?.forEach(i=>this.#t(`${i}/`,!1,void 0,!0,"tree:add:dir",!0,r)),e?.forEach(i=>this.#t(i,!0,void 0,!0,"tree:add:file",!0,r)),this.ready=!0,this.emit("tree:ready")}createEntry(t,e,r=void 0,i=!1){let s=(e?"file":"dir")+":create";this.#t(t,e,r,i,s)}async loadEntry(t){return this.OT?.read(t)}async updateEntry(t,e,r){return this.OT?.update(t,e,r)}renameEntry(t,e){let r=!!t.isFile,i=t.path,s=i.lastIndexOf(t.name),o=i.substring(0,s)+e;t.isDir&&(o+="/");let a=(t.isFile?"file":"dir")+":rename";this.#e(r,i,o,a)}moveEntry(t,e,r){let i=!!t.isFile,s=(t.isFile?"file":"dir")+":move";this.#e(i,e,r,s)}removeEntry(t){let{path:e,isFile:r,parentDir:i}=t,s=(r?"file":"dir")+":delete",o={path:e,emptyDir:this.removeEmptyDir};this.emit(s,o,()=>{let a=this.__delete(e,r);return this.OT?.delete(e),o.removed=a,setTimeout(()=>i.checkEmpty(),10),a})}async#r(t){let r=await(await fetch(t)).json();if(r){let{dirs:i,files:s}=r;this.setContent({dirs:i,files:s})}}#t(t,e,r=void 0,i=!1,s,o=!1,a=!1){let{entries:h}=this;if(h[t])return this.emit(`${s}:error`,{error:l.PATH_EXISTS(t)});let d={path:t,content:r,bulk:i},u=(L=r)=>{let R=this.__create(t,e);return a||this.OT?.create(t,e,L),d.entry=R,R};if(o)return u();this.emit(s,d,u)}#i({dirPath:t}){let{entries:e}=this;if(!t)return this.rootDir;let r=this.find(`[path="${t}"`);return r||(r=this.rootDir,t.split("/").forEach(i=>{if(!i)return;let s=(r.path==="."?"":r.path)+i+"/",o=this.find(`[path="${s}"`);o||(o=new E,o.path=s,r.addEntry(o),e[s]=o),r=o}),r)}#e(t,e,r,i){let{entries:s}=this;if(e===r)return;if(r.startsWith(e)&&r.replace(e,"").includes("/"))return this.emit(`${i}:error`,{oldPath:e,newPath:r,error:l.PATH_INSIDE_ITSELF(e)});if(s[r])return this.emit(`${i}:error`,{oldPath:e,newPath:r,error:l.PATH_EXISTS(r)});let o={oldPath:e,newPath:r};this.emit(i,o,()=>{let a=this.__move(t,e,r);return this.OT?.move(t,e,r),o.entry=a,a})}__create(t,e){let{entries:r}=this,i=e?m:E,s=r[t]=new i;return s.path=t,this.#i(s).addEntry(s),s}__move(t,e,r,i){let{entries:s}=this,o=s[e];Object.keys(s).forEach(d=>{if(d.startsWith(e)){let u=s[d];u.updatePath(t,e,r)&&(s[u.path]=u,delete s[d])}});let{dirPath:a}=s[r]=o;return(a?s[a]:this.rootDir).addEntry(o),o}__update(t,e,r,i){this.entries[t]?.dispatchEvent(new CustomEvent("content:update",{detail:{type:e,update:r,ours:i}}))}__delete(t,e,r){let{entries:i}=this,s=i[t],o=[s];return e?(s.remove(),delete i[t]):Object.entries(i).forEach(([a,h])=>{a.startsWith(t)&&(o.push(h),h.remove(),delete i[a])}),o}select(t){let e=this.entries[t];if(!e)throw new Error(l.PATH_DOES_NOT_EXIST(t));e.select()}unselect(){this.find(".selected")?.classList.remove("selected")}selectEntry(t,e={}){let r=(t.isFile?"file":"dir")+":click";e.path=t.path,this.emit(r,e,()=>(t.select(),e.entry=t,t))}toggleDirectory(t,e={}){let r="dir:toggle";e.path=t.path,this.emit(r,e,()=>{e.entry=t,t.toggle()})}sort(){this.rootDir.sort()}toJSON(){return JSON.stringify(Object.keys(this.entries).sort())}toString(){return this.toJSON()}toValue(){return this}};f.define("file-tree",D);
